trigger:
- noon

pool: vb26

stages:

# =========================================================
# STAGE 1: SOFTWARE COMPOSITION ANALYSIS (Retire.js)
# =========================================================
- stage: SoftwareCompositionAnalysis
  displayName: Software Composition Analysis
  jobs:
  - job: DependencyVulnerabilityScan
    displayName: Dependency Vulnerability Scan
    steps:

    - task: NodeTool@0
      displayName: Install Node.js
      inputs:
        versionSpec: '16.x'

    - task: PowerShell@2
      displayName: Run Retire.js Scan
      inputs:
        targetType: 'inline'
        script: |
          npm install -g retire
          npm install

          retire --exitwith 1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Retire.js vulnerabilities detected â€“ ignoring for now"
            exit 0
          }

# =========================================================
# STAGE 2: CODE QUALITY & LINTING
# =========================================================
- stage: CodeQualityChecks
  displayName: Code Quality & Linting
  jobs:
  - job: LintingChecks
    displayName: Linting Checks
    steps:

    - task: NodeTool@0
      displayName: Install Node.js
      inputs:
        versionSpec: '16.x'

    - task: PowerShell@2
      continueOnError: true
      displayName: JavaScript Linting (Biome)
      inputs:
        targetType: 'inline'
        script: |
          Invoke-WebRequest `
            -Uri "https://github.com/biomejs/biome/releases/download/cli/v2.3.8/biome-win32-x64.exe" `
            -OutFile "$(Agent.ToolsDirectory)/biome.exe"

          & "$(Agent.ToolsDirectory)/biome.exe" lint "$(System.DefaultWorkingDirectory)/src/"

    - task: PowerShell@2
      continueOnError: true
      displayName: CSS Linting (Stylelint)
      inputs:
        targetType: 'inline'
        script: |
          npm install -g stylelint stylelint-config-standard
          stylelint "$(System.DefaultWorkingDirectory)/src/**/*.css" || exit 0

    - task: PowerShell@2
      continueOnError: true
      displayName: YAML Linting (yamllint)
      inputs:
        targetType: 'inline'
        script: |
          python -m pip install yamllint
          python -m yamllint "$(System.DefaultWorkingDirectory)"
          if ($LASTEXITCODE -ne 0) { exit 0 }

    - task: PowerShell@2
      continueOnError: true
      displayName: Markdown Linting
      inputs:
        targetType: 'inline'
        script: |
          npm install -g markdownlint-cli
          markdownlint "$(System.DefaultWorkingDirectory)"
          if ($LASTEXITCODE -ne 0) { exit 0 }

# =========================================================
# STAGE 3: BUILD & ARTIFACT PUBLISH
# =========================================================
- stage: BuildAndPackage
  displayName: Build & Package
  jobs:
  - job: ApplicationBuild
    displayName: Application Build
    steps:

    - task: NodeTool@0
      displayName: Install Node.js
      inputs:
        versionSpec: '16.x'

    - task: PowerShell@2
      displayName: Install Dependencies
      inputs:
        targetType: 'inline'
        script: |
          npm install

    - task: PowerShell@2
      displayName: Build Application
      inputs:
        targetType: 'inline'
        script: |
          npm run build

    - task: PublishPipelineArtifact@1
      displayName: Publish Build Artifact
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/build'
        artifact: 'todo-ui'
        publishLocation: 'pipeline'
